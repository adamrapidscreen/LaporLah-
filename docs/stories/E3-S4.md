# E3-S4: Wire createReport Server Action

## Description
Create the `createReport` server action that validates form data with Zod, checks authentication and ban status, inserts the report into the database, auto-follows the creator, awards points, updates the activity streak, checks for badge eligibility, and redirects to the new report's detail page.

## Dependencies
- Stories: E1-S2, E1-S3
- Files: `supabase/migrations/001_create_tables.sql`, `src/lib/supabase/server.ts`, `src/lib/supabase/admin.ts`

## Tasks
1. `src/lib/actions/reports.ts`: Create `createReport` server action with Zod validation, auth check, ban check, INSERT report, INSERT follow, call `award_points(10)`, `update_streak`, `check_and_award_badges`, `revalidatePath('/')`, redirect to `/report/[id]`
2. `src/lib/constants/categories.ts`: Create categories constant (if not already from E3-S1)
3. `src/lib/constants/statuses.ts`: Create report statuses constant with labels and colors
4. `src/lib/types/index.ts`: Create shared TypeScript types for reports, forms, and action states

## Implementation Notes

### Server Action (`src/lib/actions/reports.ts`)
```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';
import { z } from 'zod';

import { createClient } from '@/lib/supabase/server';

const createReportSchema = z.object({
  title: z.string().min(1, 'Title is required').max(100, 'Title must be 100 characters or less'),
  description: z.string().min(1, 'Description is required').max(2000, 'Description must be 2000 characters or less'),
  category: z.enum(['infrastructure', 'cleanliness', 'safety', 'facilities', 'other']),
  photo_url: z.string().url().optional().nullable(),
  latitude: z.coerce.number().optional().nullable(),
  longitude: z.coerce.number().optional().nullable(),
  area_name: z.string().optional().nullable(),
});

interface ActionState {
  error: string | null;
}

export async function createReport(
  prevState: ActionState,
  formData: FormData
): Promise<ActionState> {
  const supabase = await createClient();

  // Check auth
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return { error: 'You must be signed in to create a report.' };
  }

  // Check banned
  const { data: profile } = await supabase
    .from('users')
    .select('is_banned')
    .eq('id', user.id)
    .single();

  if (profile?.is_banned) {
    return { error: 'Your account has been suspended.' };
  }

  // Validate form data
  const parsed = createReportSchema.safeParse({
    title: formData.get('title'),
    description: formData.get('description'),
    category: formData.get('category'),
    photo_url: formData.get('photo_url') || null,
    latitude: formData.get('latitude') || null,
    longitude: formData.get('longitude') || null,
    area_name: formData.get('area_name') || null,
  });

  if (!parsed.success) {
    return { error: parsed.error.errors[0].message };
  }

  // Insert report
  const { data: report, error: insertError } = await supabase
    .from('reports')
    .insert({
      creator_id: user.id,
      ...parsed.data,
    })
    .select('id')
    .single();

  if (insertError) {
    return { error: 'Failed to create report. Please try again.' };
  }

  // Auto-follow creator on their own report
  await supabase.from('follows').insert({
    user_id: user.id,
    report_id: report.id,
  });

  // Award points (10 pts for creating a report)
  await supabase.rpc('award_points', {
    p_user_id: user.id,
    p_action: 'create_report',
    p_points: 10,
    p_report_id: report.id,
  });

  // Update streak
  await supabase.rpc('update_streak', { p_user_id: user.id });

  // Check for badge eligibility
  await supabase.rpc('check_and_award_badges', { p_user_id: user.id });

  revalidatePath('/');
  redirect(`/report/${report.id}`);
}
```

### Statuses Constant (`src/lib/constants/statuses.ts`)
```typescript
export const STATUSES = [
  { value: 'open', label: 'Open', color: 'hsl(var(--status-open))' },
  { value: 'acknowledged', label: 'Acknowledged', color: 'hsl(var(--status-acknowledged))' },
  { value: 'in_progress', label: 'In Progress', color: 'hsl(var(--status-in-progress))' },
  { value: 'resolved', label: 'Resolved', color: 'hsl(var(--status-resolved))' },
  { value: 'closed', label: 'Closed', color: 'hsl(var(--status-closed))' },
] as const;

export type StatusValue = (typeof STATUSES)[number]['value'];
```

### Shared Types (`src/lib/types/index.ts`)
```typescript
import type { CategoryValue } from '@/lib/constants/categories';
import type { StatusValue } from '@/lib/constants/statuses';

export interface Report {
  id: string;
  creator_id: string;
  title: string;
  description: string;
  category: CategoryValue;
  status: StatusValue;
  photo_url: string | null;
  latitude: number | null;
  longitude: number | null;
  area_name: string | null;
  follower_count: number;
  is_hidden: boolean;
  created_at: string;
  updated_at: string;
  creator?: {
    id: string;
    full_name: string;
    avatar_url: string | null;
  };
}

export interface ActionState {
  error: string | null;
}
```

### Server Action Conventions
- Always `'use server'` at top of file
- Validate all inputs with Zod
- Check `auth.getUser()` first (not `getSession()` — getUser is secure)
- Check `is_banned` before any write operation
- Return `{ error: string }` on failure — never throw
- Use `revalidatePath` to bust cache on success
- Use `redirect` after successful mutation (throws NEXT_REDIRECT internally)

## Acceptance Criteria
- [ ] `createReport` is a valid server action (`'use server'` directive)
- [ ] Form data validated with Zod schema (title, description, category required)
- [ ] Returns `{ error }` if user is not authenticated
- [ ] Returns `{ error }` if user is banned
- [ ] Returns `{ error }` with first Zod validation error message on invalid data
- [ ] Report inserted into `reports` table with `creator_id` from auth
- [ ] Creator auto-followed on their own report (INSERT into `follows`)
- [ ] 10 points awarded via `award_points` RPC
- [ ] Streak updated via `update_streak` RPC
- [ ] Badge check triggered via `check_and_award_badges` RPC
- [ ] Home feed cache invalidated via `revalidatePath('/')`
- [ ] Redirects to `/report/[id]` on success
- [ ] Statuses constant exported with values, labels, and colors
- [ ] Shared types exported for `Report` and `ActionState`
