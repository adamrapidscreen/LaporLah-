# E4-S4: Implement Status Change Side Effects

## Description
Enhance the `updateReportStatus` server action with side effects: notify followers on any status change, set `resolved_at` timestamp and `resolved_by` user when status becomes "resolved", and track the resolver for downstream point awards at confirmation time.

## Dependencies
- Stories: E4-S3 (updateReportStatus action), E1-S2 (notify_followers DB function, award_points DB function)
- Files: `src/lib/actions/reports.ts`, database functions (`notify_followers`, `award_points`)

## Tasks
1. `src/lib/actions/reports.ts`: Extend `updateReportStatus` to call `notify_followers(report_id, 'status_change', message, exclude_user)` after every successful status change. When status transitions to `resolved`, set `resolved_at = NOW()` and `resolved_by = user.id` in the update query. When status transitions to `closed` (by admin/creator directly, not via community confirmation), call `award_points` to give 25 points to the report creator.
2. Ensure the notification message is descriptive and bilingual (e.g., "Report status updated to Diselesaikan / Resolved").

## Implementation Notes

### Extended updateReportStatus
```tsx
// Additions to updateReportStatus in src/lib/actions/reports.ts

export async function updateReportStatus(reportId: string, newStatus: ReportStatus) {
  // ... existing validation and auth checks from E4-S3 ...

  // Build update payload
  const updatePayload: Record<string, unknown> = { status: newStatus };
  if (newStatus === 'resolved') {
    updatePayload.resolved_at = new Date().toISOString();
    updatePayload.resolved_by = user.id; // Track who proposed resolution
  }

  // Update status
  const { error } = await supabase
    .from('reports')
    .update(updatePayload)
    .eq('id', reportId);

  if (error) return { error: 'Failed to update status' };

  // Side effect: Notify followers
  const statusLabel = statusConfig[newStatus].labelMs;
  await supabase.rpc('notify_followers', {
    p_report_id: reportId,
    p_type: 'status_change',
    p_message: `Status dikemaskini kepada ${statusLabel}`,
    p_exclude_user: user.id,
  });

  // Side effect: When status becomes 'resolved', notify with confirmation request
  if (newStatus === 'resolved') {
    await supabase.rpc('notify_followers', {
      p_report_id: reportId,
      p_type: 'confirmation_request',
      p_message: 'Adakah isu ini telah diselesaikan? Sahkan sekarang.',
      p_exclude_user: user.id,
    });
  }

  revalidatePath(`/report/${reportId}`);
  return { success: true };
}
```

### notify_followers RPC Parameters
The `notify_followers` database function expects:
- `p_report_id` (uuid): The report being updated
- `p_type` (text): Notification type — `'status_change'` or `'confirmation_request'`
- `p_message` (text): Human-readable notification text
- `p_exclude_user` (uuid): User ID to exclude from notification (the person who made the change)

### Important: No Points Awarded at Resolve Time
- **Do NOT award 15 resolver points when proposing "Resolved"** — those points are awarded later in E7-S3 when the community actually confirms the resolution (≥3 votes). This prevents double-payment.
- The `resolved_by` column is set here so E7-S3 can look it up at confirmation time.
- 25 creator points for `report_closed` are also handled in E7-S3 (community confirmation path), not here.

### resolved_at and resolved_by Fields
- `resolved_at` is set when transitioning to `resolved` — used by E7-S3/E7-S4 for 72h countdown
- `resolved_by` tracks who proposed the resolution — used by E7-S3 to award 15 pts at confirmation
- If status reverts (community disputes), E7-S3 clears `resolved_at` but retains `resolved_by` for audit

## Acceptance Criteria
- [ ] `notify_followers` is called after every successful status change
- [ ] Notification message includes the new status in Malay (bilingual)
- [ ] The user who initiated the status change is excluded from notifications
- [ ] `resolved_at` is set to current timestamp when status becomes `resolved`
- [ ] `resolved_by` is set to the current user's ID when status becomes `resolved`
- [ ] A `confirmation_request` notification is sent to followers when status becomes `resolved`
- [ ] No points are awarded in this action (points are handled in E7-S3 at confirmation time)
- [ ] Side effects do not block the response — errors in side effects are logged but don't fail the action
- [ ] Path is still revalidated after all side effects complete
