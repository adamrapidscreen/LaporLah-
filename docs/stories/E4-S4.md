# E4-S4: Implement Status Change Side Effects

## Description
Enhance the `updateReportStatus` server action with side effects: notify followers on any status change, set `resolved_at` timestamp when status becomes "resolved", and award points when applicable.

## Dependencies
- Stories: E4-S3 (updateReportStatus action), E1-S2 (notify_followers DB function, award_points DB function)
- Files: `src/lib/actions/reports.ts`, database functions (`notify_followers`, `award_points`)

## Tasks
1. `src/lib/actions/reports.ts`: Extend `updateReportStatus` to call `notify_followers(report_id, 'status_change', message, exclude_user)` after every successful status change. When status transitions to `resolved`, also set `resolved_at = NOW()` in the update query. When status transitions to `closed`, call `award_points` to give 25 points to the report creator.
2. Ensure the notification message is descriptive and bilingual (e.g., "Report status updated to Diselesaikan / Resolved").

## Implementation Notes

### Extended updateReportStatus
```tsx
// Additions to updateReportStatus in src/lib/actions/reports.ts

export async function updateReportStatus(reportId: string, newStatus: ReportStatus) {
  // ... existing validation and auth checks from E4-S3 ...

  // Build update payload
  const updatePayload: Record<string, unknown> = { status: newStatus };
  if (newStatus === 'resolved') {
    updatePayload.resolved_at = new Date().toISOString();
  }

  // Update status
  const { error } = await supabase
    .from('reports')
    .update(updatePayload)
    .eq('id', reportId);

  if (error) return { error: 'Failed to update status' };

  // Side effect: Notify followers
  const statusLabel = statusConfig[newStatus].labelMs;
  await supabase.rpc('notify_followers', {
    p_report_id: reportId,
    p_type: 'status_change',
    p_message: `Status dikemaskini kepada ${statusLabel}`,
    p_exclude_user: user.id,
  });

  // Side effect: Award points on close
  if (newStatus === 'closed') {
    await supabase.rpc('award_points', {
      p_user_id: report.user_id,
      p_action: 'report_closed',
      p_points: 25,
      p_report_id: reportId,
    });
  }

  // Side effect: Award points to resolver when resolved
  if (newStatus === 'resolved') {
    await supabase.rpc('award_points', {
      p_user_id: user.id,
      p_action: 'resolution_confirmed',
      p_points: 15,
      p_report_id: reportId,
    });
  }

  revalidatePath(`/report/${reportId}`);
  return { success: true };
}
```

### notify_followers RPC Parameters
The `notify_followers` database function expects:
- `p_report_id` (uuid): The report being updated
- `p_type` (text): Notification type — `'status_change'`
- `p_message` (text): Human-readable notification text
- `p_exclude_user` (uuid): User ID to exclude from notification (the person who made the change)

### Points Awarded on Status Changes
| Transition | Points | Recipient | Action Key |
|---|---|---|---|
| Any → `resolved` | 15 | User who resolved | `resolution_confirmed` |
| Any → `closed` | 25 | Report creator | `report_closed` |

### resolved_at Field
- Set `resolved_at = NOW()` only when transitioning to `resolved`
- This field is used for reporting metrics and display on the detail page
- If status moves back (edge case), `resolved_at` is not cleared

## Acceptance Criteria
- [ ] `notify_followers` is called after every successful status change
- [ ] Notification message includes the new status in Malay (bilingual)
- [ ] The user who initiated the status change is excluded from notifications
- [ ] `resolved_at` is set to current timestamp when status becomes `resolved`
- [ ] 25 points are awarded to the report creator when status becomes `closed`
- [ ] 15 points are awarded to the resolver when status becomes `resolved`
- [ ] `award_points` is called with correct parameters (user_id, action, points, report_id)
- [ ] Side effects do not block the response — errors in side effects are logged but don't fail the action
- [ ] Path is still revalidated after all side effects complete
