# E7-S1: Build Vote Panel Component

## Description
Create the community confirmation vote panel as a Client Component that appears on report detail pages when a report's status is 'resolved'. The panel displays a 72-hour countdown timer, "Sahkan" (confirm) and "Belum" (not yet) vote buttons with live vote counts, helper text explaining the 3-confirmation threshold, and reflects the current user's existing vote if they have already voted.

## Dependencies
- Stories: E4-S1 (report detail page), E4-S3 (status update mechanism)
- Files: `src/app/report/[id]/page.tsx`, `src/components/ui/button.tsx`, `src/components/ui/card.tsx`

## Tasks
1. `src/components/confirmation/vote-panel.tsx`: Create Client Component with the following:
   - Accept props: `reportId`, `resolvedAt`, `initialVotes` (confirmed/not_yet counts), `userVote` (existing vote or null)
   - Render countdown timer component (from E7-S4)
   - Render "Sahkan" and "Belum" buttons with current vote counts
   - Call `castVote` server action on button click with optimistic UI update
   - Disable both buttons after user has voted, highlight the chosen vote
   - Show helper text: "Perlukan 3 pengesahan untuk tutup" ("Needs 3 confirmations to close")
   - Handle loading/pending state during vote submission
2. `src/app/report/[id]/page.tsx`: Integrate vote panel into report detail page — query confirmations table for vote counts and current user's vote, conditionally render `VotePanel` when `report.status === 'resolved'`

## Implementation Notes

### Component Structure
```tsx
// src/components/confirmation/vote-panel.tsx
'use client';

import { useTransition, useState } from 'react';
import { Button } from '@/components/ui/button';
import { Countdown } from '@/components/confirmation/countdown';
import { castVote } from '@/lib/actions/votes';
import { cn } from '@/lib/utils';

interface VotePanelProps {
  reportId: string;
  resolvedAt: string;
  initialVotes: { confirmed: number; notYet: number };
  userVote: 'confirmed' | 'not_yet' | null;
}

export function VotePanel({ reportId, resolvedAt, initialVotes, userVote }: VotePanelProps) {
  const [isPending, startTransition] = useTransition();
  const [votes, setVotes] = useState(initialVotes);
  const [currentVote, setCurrentVote] = useState(userVote);

  const handleVote = (vote: 'confirmed' | 'not_yet') => {
    // Optimistic update
    setCurrentVote(vote);
    setVotes(prev => ({
      ...prev,
      [vote === 'confirmed' ? 'confirmed' : 'notYet']: prev[vote === 'confirmed' ? 'confirmed' : 'notYet'] + 1,
    }));

    startTransition(async () => {
      const result = await castVote(reportId, vote);
      if (result?.error) {
        // Revert optimistic update
        setCurrentVote(userVote);
        setVotes(initialVotes);
      }
    });
  };

  const hasVoted = currentVote !== null;

  return (
    <div className="bg-primary/5 border border-primary/20 rounded-lg p-4 space-y-3">
      <div className="flex items-center justify-between">
        <h3 className="font-semibold text-sm">Pengesahan Komuniti</h3>
        <Countdown resolvedAt={resolvedAt} />
      </div>

      <div className="flex gap-3">
        <Button
          onClick={() => handleVote('confirmed')}
          disabled={hasVoted || isPending}
          variant={currentVote === 'confirmed' ? 'default' : 'outline'}
          className="flex-1"
        >
          ✅ Sahkan ({votes.confirmed})
        </Button>
        <Button
          onClick={() => handleVote('not_yet')}
          disabled={hasVoted || isPending}
          variant={currentVote === 'not_yet' ? 'destructive' : 'outline'}
          className="flex-1"
        >
          ❌ Belum ({votes.notYet})
        </Button>
      </div>

      <p className="text-xs text-muted-foreground text-center">
        Perlukan 3 pengesahan untuk tutup
      </p>
    </div>
  );
}
```

### Integrating into Report Detail Page
```tsx
// In src/app/report/[id]/page.tsx — add after fetching report
const { data: confirmations } = await supabase
  .from('confirmations')
  .select('vote, user_id')
  .eq('report_id', id);

const confirmedCount = confirmations?.filter(c => c.vote === 'confirmed').length ?? 0;
const notYetCount = confirmations?.filter(c => c.vote === 'not_yet').length ?? 0;
const userVote = confirmations?.find(c => c.user_id === user?.id)?.vote ?? null;

// Conditionally render
{report.status === 'resolved' && (
  <VotePanel
    reportId={report.id}
    resolvedAt={report.resolved_at}
    initialVotes={{ confirmed: confirmedCount, notYet: notYetCount }}
    userVote={userVote}
  />
)}
```

### Styling Notes
- Container: `bg-primary/5 border border-primary/20 rounded-lg p-4`
- Vote buttons use shadcn `Button` with `outline` variant by default, switch to `default`/`destructive` when selected
- Helper text: `text-xs text-muted-foreground`

## Acceptance Criteria
- [ ] Vote panel renders only when report status is 'resolved'
- [ ] Countdown timer displays remaining time from `resolved_at`
- [ ] "Sahkan" and "Belum" buttons show current vote counts
- [ ] Clicking a vote button calls `castVote` server action
- [ ] Buttons are disabled after user votes (prevents double-voting)
- [ ] User's existing vote is highlighted if they already voted
- [ ] Optimistic UI updates vote count immediately on click
- [ ] Helper text "Perlukan 3 pengesahan untuk tutup" is visible
- [ ] Component uses 'use client' directive
- [ ] Styling matches design system: bg-primary/5, border-primary/20, rounded-lg, p-4
