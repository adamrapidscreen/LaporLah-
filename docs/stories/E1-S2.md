# E1-S2: Set Up Supabase Database Schema — Tables, Enums, Indexes, and RLS Policies

## Description
Create the complete Supabase database schema for LaporLah including all enums, tables with proper relationships, indexes for query performance, RLS policies for row-level security, and database functions for the gamification system.

## Dependencies
- Stories: E1-S1
- Files: `package.json` (project initialized)

## Tasks
1. `supabase/migrations/001_create_tables.sql`: Define all enums (`report_category`, `report_status`, `user_role`, `badge_type`, `badge_tier`, `vote_type`, `notification_type`) and all tables (`users`, `reports`, `comments`, `follows`, `confirmations`, `badges`, `notifications`, `flags`, `point_events`) with proper foreign keys, constraints, and indexes
2. `supabase/migrations/002_create_rls_policies.sql`: Enable RLS on all tables and create policies — users can read public data, only modify own records; admins have elevated access; banned users blocked from write operations
3. `supabase/migrations/003_create_functions.sql`: Create PostgreSQL functions `award_points(user_id, action, points, report_id)`, `check_and_award_badges(user_id)`, `update_streak(user_id)`, `notify_followers(report_id, notification_type, actor_id)`
4. `.env.local.example`: Document required environment variables (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `NEXT_PUBLIC_GOOGLE_CLIENT_ID`)

## Implementation Notes

### Enums
```sql
CREATE TYPE report_category AS ENUM ('infrastructure', 'cleanliness', 'safety', 'facilities', 'other');
CREATE TYPE report_status AS ENUM ('open', 'acknowledged', 'in_progress', 'resolved', 'closed');
CREATE TYPE user_role AS ENUM ('user', 'admin');
CREATE TYPE badge_type AS ENUM ('spotter', 'kampung_hero', 'closer');
CREATE TYPE badge_tier AS ENUM ('bronze', 'silver', 'gold');
CREATE TYPE vote_type AS ENUM ('confirmed', 'not_yet');
CREATE TYPE notification_type AS ENUM ('status_change', 'new_comment', 'confirmation_request', 'badge_earned', 'report_followed');
```

### Core Tables
```sql
-- users: synced from Supabase Auth
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT NOT NULL,
  avatar_url TEXT,
  role user_role DEFAULT 'user',
  is_banned BOOLEAN DEFAULT FALSE,
  total_points INTEGER DEFAULT 0,
  current_streak INTEGER DEFAULT 0,
  longest_streak INTEGER DEFAULT 0,
  last_active_date DATE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- reports
CREATE TABLE reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id UUID NOT NULL REFERENCES users(id),
  title TEXT NOT NULL CHECK (char_length(title) <= 100),
  description TEXT NOT NULL CHECK (char_length(description) <= 2000),
  category report_category NOT NULL,
  status report_status DEFAULT 'open',
  photo_url TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  area_name TEXT,
  follower_count INTEGER DEFAULT 0,
  is_hidden BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### Points System Constants
| Action | Points |
|--------|--------|
| Create report | 10 |
| Comment | 5 |
| New follower on your report | 3 |
| Confirmation vote | 8 |
| Report closed | 25 (to creator) |
| Resolution confirmed | 15 (to resolver) |

### RLS Policy Pattern
```sql
-- Example: users can read all non-hidden reports
CREATE POLICY "Anyone can view non-hidden reports"
  ON reports FOR SELECT
  USING (is_hidden = FALSE);

-- Example: authenticated users can create reports
CREATE POLICY "Authenticated users can create reports"
  ON reports FOR INSERT
  WITH CHECK (
    auth.uid() = creator_id
    AND NOT EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND is_banned = TRUE)
  );
```

## Acceptance Criteria
- [ ] All 5 enums created successfully
- [ ] All 9 tables created with proper foreign key relationships
- [ ] Indexes exist on frequently queried columns (reports.status, reports.category, reports.creator_id, comments.report_id, follows.report_id)
- [ ] RLS enabled on all tables with appropriate read/write policies
- [ ] Banned users cannot INSERT/UPDATE on reports, comments, confirmations
- [ ] `award_points` function correctly inserts into `point_events` and updates `users.total_points`
- [ ] `check_and_award_badges` evaluates badge criteria and awards if threshold met
- [ ] `update_streak` increments or resets `current_streak` based on `last_active_date`
- [ ] `notify_followers` creates notification rows for all followers of a report
- [ ] `.env.local.example` documents all required environment variables
- [ ] Migrations run cleanly on a fresh Supabase instance
