# E6-S4: Build Notifications Page

## Description
Create the notifications list page as a Server Component that displays all notifications for the current user, with visual distinction for unread items, click-to-navigate behavior, and "Mark all as read" functionality. Includes notification item component, server actions, and loading skeleton.

## Dependencies
- Stories: E6-S3 (notification bell), E1-S2 (notifications table)
- Files: `src/components/notifications/notification-bell.tsx`, database `notifications` table

## Tasks
1. `src/components/notifications/notification-item.tsx`: Create presentational component for a single notification. Unread items have `bg-primary/5` background, read items use default background. Show notification icon, message, relative time, and link to the related report.
2. `src/app/notifications/page.tsx`: Create Server Component that fetches all notifications for the current user ordered by `created_at` descending (newest first). Render notification list with unread/read visual distinction. Include "Mark all as read" button at the top.
3. `src/app/notifications/loading.tsx`: Create loading skeleton matching the notifications page layout.
4. `src/lib/actions/notifications.ts`: Create `markAsRead` (single notification) and `markAllAsRead` server actions.

## Implementation Notes

### Notification Item Component
```tsx
// src/components/notifications/notification-item.tsx
'use client';

import Link from 'next/link';
import { cn } from '@/lib/utils';
import { formatTimeAgo } from '@/lib/utils';
import { Bell, MessageCircle, Heart, ArrowUpCircle } from 'lucide-react';
import { markAsRead } from '@/lib/actions/notifications';

interface Notification {
  id: string;
  type: string;
  message: string;
  report_id: string;
  is_read: boolean;
  created_at: string;
}

interface NotificationItemProps {
  notification: Notification;
}

const typeIcons: Record<string, React.ElementType> = {
  status_change: ArrowUpCircle,
  new_comment: MessageCircle,
  new_follower: Heart,
  default: Bell,
};

export function NotificationItem({ notification }: NotificationItemProps) {
  const Icon = typeIcons[notification.type] || typeIcons.default;

  async function handleClick() {
    if (!notification.is_read) {
      await markAsRead(notification.id);
    }
  }

  return (
    <Link
      href={`/report/${notification.report_id}`}
      onClick={handleClick}
      className={cn(
        'flex items-start gap-3 rounded-lg px-4 py-3 transition-colors hover:bg-accent',
        !notification.is_read && 'bg-primary/5'
      )}
    >
      <Icon className="mt-0.5 h-5 w-5 shrink-0 text-muted-foreground" />
      <div className="flex-1 space-y-1">
        <p className={cn(
          'text-sm',
          !notification.is_read && 'font-medium'
        )}>
          {notification.message}
        </p>
        <p className="text-xs text-muted-foreground">
          {formatTimeAgo(notification.created_at)}
        </p>
      </div>
      {!notification.is_read && (
        <div className="mt-2 h-2 w-2 shrink-0 rounded-full bg-primary" />
      )}
    </Link>
  );
}
```

### Notifications Page
```tsx
// src/app/notifications/page.tsx
import { createServerClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { NotificationItem } from '@/components/notifications/notification-item';
import { markAllAsRead } from '@/lib/actions/notifications';

export default async function NotificationsPage() {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const { data: notifications } = await supabase
    .from('notifications')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  const hasUnread = notifications?.some((n) => !n.is_read);

  return (
    <div className="mx-auto max-w-2xl p-4">
      <div className="mb-4 flex items-center justify-between">
        <h1 className="text-xl font-bold">Notifikasi / Notifications</h1>
        {hasUnread && (
          <form action={markAllAsRead}>
            <Button variant="ghost" size="sm" type="submit">
              Tandai semua dibaca / Mark all read
            </Button>
          </form>
        )}
      </div>

      {!notifications || notifications.length === 0 ? (
        <p className="py-12 text-center text-sm text-muted-foreground">
          Tiada notifikasi / No notifications
        </p>
      ) : (
        <div className="divide-y divide-border">
          {notifications.map((notification) => (
            <NotificationItem key={notification.id} notification={notification} />
          ))}
        </div>
      )}
    </div>
  );
}
```

### Server Actions
```tsx
// src/lib/actions/notifications.ts
'use server';

import { revalidatePath } from 'next/cache';
import { createServerClient } from '@/lib/supabase/server';

export async function markAsRead(notificationId: string) {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { error: 'Not authenticated' };

  const { error } = await supabase
    .from('notifications')
    .update({ is_read: true })
    .eq('id', notificationId)
    .eq('user_id', user.id); // ensure ownership

  if (error) return { error: 'Failed to mark as read' };

  revalidatePath('/notifications');
  return { success: true };
}

export async function markAllAsRead() {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { error: 'Not authenticated' };

  const { error } = await supabase
    .from('notifications')
    .update({ is_read: true })
    .eq('user_id', user.id)
    .eq('is_read', false);

  if (error) return { error: 'Failed to mark all as read' };

  revalidatePath('/notifications');
  return { success: true };
}
```

### Loading Skeleton
```tsx
// src/app/notifications/loading.tsx
import { Skeleton } from '@/components/ui/skeleton';

export default function NotificationsLoading() {
  return (
    <div className="mx-auto max-w-2xl space-y-1 p-4">
      <Skeleton className="mb-4 h-8 w-48" />
      {Array.from({ length: 8 }).map((_, i) => (
        <div key={i} className="flex items-start gap-3 px-4 py-3">
          <Skeleton className="h-5 w-5 rounded-full" />
          <div className="flex-1 space-y-2">
            <Skeleton className="h-4 w-3/4" />
            <Skeleton className="h-3 w-20" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

### Design Specifications
- Unread notification: `bg-primary/5` background with unread dot indicator
- Read notification: default background
- Unread dot: `h-2 w-2 rounded-full bg-primary`, right-aligned
- Unread text: `font-medium` for emphasis
- Icon per type: ArrowUpCircle (status), MessageCircle (comment), Heart (follow), Bell (default)
- Timestamp: `text-xs text-muted-foreground`, relative time ago
- Empty state: centered, bilingual text
- Page max-width: `max-w-2xl`, centered

## Acceptance Criteria
- [ ] Notifications page renders at `/notifications` for authenticated users
- [ ] Redirects to `/login` for unauthenticated users
- [ ] Notifications are ordered by newest first
- [ ] Unread notifications have `bg-primary/5` background and unread dot
- [ ] Read notifications have default background
- [ ] Each notification shows type icon, message, and relative time
- [ ] Clicking a notification navigates to the related report
- [ ] Clicking an unread notification marks it as read
- [ ] "Mark all as read" button appears when there are unread notifications
- [ ] `markAllAsRead` action updates all unread notifications for the user
- [ ] `markAsRead` action updates a single notification (with ownership check)
- [ ] Empty state shows bilingual "No notifications" message
- [ ] Loading skeleton displays while data is being fetched
- [ ] Notification item component shows different icons per notification type
