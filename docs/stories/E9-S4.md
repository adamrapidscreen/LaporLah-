# E9-S4: Build User Management View

## Description
Create the user management admin page that lists all users with their report count, flag count, and banned status. Provide ban/unban toggle functionality for each user.

## Dependencies
- Stories: E9-S1 (admin layout), E9-S5 (admin server actions â€” banUser, unbanUser)
- Files: `src/app/admin/layout.tsx`, `src/lib/actions/admin.ts`

## Tasks
1. `src/app/admin/users/page.tsx`: Create Server Component that:
   - Queries `users` table with report count and flag count aggregations
   - Renders a table/list of users with columns: Avatar, Name, Email, Reports, Flags, Status, Actions
   - Status column shows "Banned" badge (destructive) or "Active" badge (default)
   - Actions column has Ban/Unban toggle button
   - Sort users with banned users first, then by flag count descending
2. `src/components/admin/user-row.tsx`: Create Client Component for each user row with:
   - User avatar and info display
   - Ban/Unban toggle button that calls `banUser`/`unbanUser` server actions
   - Loading state during action execution
   - Confirmation before banning (optional but recommended)

## Implementation Notes

### Users Page
```tsx
// src/app/admin/users/page.tsx
import { createServerClient } from '@/lib/supabase/server';
import { UserRow } from '@/components/admin/user-row';
import { Badge } from '@/components/ui/badge';

interface UserWithCounts {
  id: string;
  email: string;
  name: string;
  avatar_url: string | null;
  role: string;
  is_banned: boolean;
  report_count: number;
  flag_count: number;
}

export default async function UsersPage() {
  const supabase = await createServerClient();

  // Query users with report and flag counts
  const { data: users } = await supabase
    .from('users')
    .select(`
      id, email, name, avatar_url, role, is_banned,
      reports:reports(count),
      flags:flags(count)
    `)
    .order('is_banned', { ascending: false })
    .order('name');

  const formattedUsers: UserWithCounts[] = (users ?? []).map(u => ({
    ...u,
    report_count: u.reports?.[0]?.count ?? 0,
    flag_count: u.flags?.[0]?.count ?? 0,
  }));

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold">Users ({formattedUsers.length})</h2>
      <div className="rounded-md border">
        <div className="grid grid-cols-[1fr_auto_auto_auto] gap-4 p-3 border-b bg-muted/50 text-sm font-medium text-muted-foreground">
          <span>User</span>
          <span>Reports</span>
          <span>Flags</span>
          <span>Actions</span>
        </div>
        {formattedUsers.map((user) => (
          <UserRow key={user.id} user={user} />
        ))}
      </div>
    </div>
  );
}
```

### User Row Component
```tsx
// src/components/admin/user-row.tsx
'use client';

import { useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { banUser, unbanUser } from '@/lib/actions/admin';
import { Ban, UserCheck } from 'lucide-react';

interface UserRowProps {
  user: {
    id: string;
    email: string;
    name: string;
    avatar_url: string | null;
    is_banned: boolean;
    report_count: number;
    flag_count: number;
  };
}

export function UserRow({ user }: UserRowProps) {
  const [isPending, startTransition] = useTransition();

  const handleToggleBan = () => {
    startTransition(async () => {
      if (user.is_banned) {
        await unbanUser(user.id);
      } else {
        await banUser(user.id);
      }
    });
  };

  return (
    <div className="grid grid-cols-[1fr_auto_auto_auto] gap-4 p-3 border-b last:border-b-0 items-center">
      <div className="flex items-center gap-3">
        <Avatar className="h-8 w-8">
          <AvatarImage src={user.avatar_url ?? undefined} />
          <AvatarFallback>{user.name?.[0]?.toUpperCase() ?? '?'}</AvatarFallback>
        </Avatar>
        <div>
          <p className="text-sm font-medium">{user.name}</p>
          <p className="text-xs text-muted-foreground">{user.email}</p>
        </div>
        {user.is_banned && <Badge variant="destructive">Banned</Badge>}
      </div>
      <span className="text-sm font-mono">{user.report_count}</span>
      <span className="text-sm font-mono">{user.flag_count}</span>
      <Button
        size="sm"
        variant={user.is_banned ? 'outline' : 'destructive'}
        onClick={handleToggleBan}
        disabled={isPending}
      >
        {user.is_banned ? <><UserCheck className="h-4 w-4 mr-1" /> Unban</> : <><Ban className="h-4 w-4 mr-1" /> Ban</>}
      </Button>
    </div>
  );
}
```

## Acceptance Criteria
- [ ] Users page renders at `/admin/users`
- [ ] All users are listed with avatar, name, and email
- [ ] Report count per user is displayed
- [ ] Flag count per user is displayed
- [ ] Banned users show a "Banned" destructive badge
- [ ] Ban button calls `banUser` server action
- [ ] Unban button calls `unbanUser` server action
- [ ] Action buttons show loading/disabled state during server action
- [ ] Banned users are sorted to the top of the list
- [ ] Page is a Server Component; UserRow is a Client Component
