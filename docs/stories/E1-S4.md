# E1-S4: Configure PWA with @serwist/next â€” Service Worker, Manifest, and Icons

## Description
Set up Progressive Web App capabilities using `@serwist/next`. Create the service worker entry point, PWA manifest, app icons, and configure Next.js to wrap the build with Serwist for offline support and installability.

## Dependencies
- Stories: E1-S1
- Files: `package.json`, `next.config.ts`

## Tasks
1. Install PWA dependencies: `npm install @serwist/next` and `npm install -D serwist`
2. `src/app/sw.ts`: Create service worker entry point with Serwist default handler, precache manifest, and runtime caching for images/API
3. `public/manifest.json`: Create PWA manifest with app name, theme color, icons, display mode, start URL
4. `public/icons/`: Add placeholder icon files (icon-192x192.png, icon-512x512.png, apple-touch-icon.png)
5. `next.config.ts`: Update to wrap config with `withSerwist()` pointing to `src/app/sw.ts`
6. `src/app/manifest.ts`: Create Next.js metadata manifest route (alternative to static manifest)

## Implementation Notes

### Service Worker (`src/app/sw.ts`)
```typescript
import type { PrecacheEntry, SerwistGlobalConfig } from 'serwist';
import { Serwist } from 'serwist';

declare global {
  interface WorkerGlobalScope extends SerwistGlobalConfig {
    __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
  }
}

declare const self: ServiceWorkerGlobalScope;

const serwist = new Serwist({
  precacheEntries: self.__SW_MANIFEST,
  skipWaiting: true,
  clientsClaim: true,
  navigationPreload: true,
  runtimeCaching: [
    {
      matcher: ({ request }) => request.destination === 'image',
      handler: new (await import('serwist')).StaleWhileRevalidate({
        cacheName: 'images',
      }),
    },
  ],
});

serwist.addEventListeners();
```

### Next.js Config with Serwist (`next.config.ts`)
```typescript
import withSerwistInit from '@serwist/next';

const withSerwist = withSerwistInit({
  swSrc: 'src/app/sw.ts',
  swDest: 'public/sw.js',
});

const nextConfig = {
  // ... other config
};

export default withSerwist(nextConfig);
```

### PWA Manifest (`public/manifest.json`)
```json
{
  "name": "LaporLah!",
  "short_name": "LaporLah",
  "description": "Community-driven civic issue reporting for Malaysia",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#09090B",
  "theme_color": "#10B981",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

### Metadata Manifest Route (`src/app/manifest.ts`)
```typescript
import type { MetadataRoute } from 'next';

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'LaporLah!',
    short_name: 'LaporLah',
    description: 'Community-driven civic issue reporting for Malaysia',
    start_url: '/',
    display: 'standalone',
    background_color: '#09090B',
    theme_color: '#10B981',
    icons: [
      { src: '/icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
      { src: '/icons/icon-512x512.png', sizes: '512x512', type: 'image/png' },
    ],
  };
}
```

## Acceptance Criteria
- [ ] `@serwist/next` and `serwist` installed in package.json
- [ ] Service worker builds without errors during `next build`
- [ ] `public/sw.js` is generated on build
- [ ] PWA manifest is accessible at `/manifest.json`
- [ ] App icons exist at `/icons/icon-192x192.png` and `/icons/icon-512x512.png`
- [ ] Chrome DevTools > Application shows valid manifest and service worker
- [ ] App is installable as PWA (shows install prompt in supported browsers)
- [ ] `next.config.ts` correctly wraps config with `withSerwist()`
- [ ] Service worker pre-caches app shell and caches images at runtime
