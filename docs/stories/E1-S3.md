# E1-S3: Configure Supabase Auth with Google OAuth, Middleware, and Client Utilities

## Description
Set up Supabase authentication with Google OAuth provider. Create browser and server Supabase client utilities using `@supabase/ssr`, implement the OAuth callback route handler, and configure Next.js middleware for session refresh on every request.

## Dependencies
- Stories: E1-S1, E1-S2
- Files: `package.json`, `.env.local.example`, `supabase/migrations/001_create_tables.sql` (users table)

## Tasks
1. `src/lib/supabase/client.ts`: Create browser Supabase client singleton using `createBrowserClient` from `@supabase/ssr`
2. `src/lib/supabase/server.ts`: Create server-side Supabase client using `createServerClient` from `@supabase/ssr` with Next.js cookies integration
3. `src/lib/supabase/admin.ts`: Create admin Supabase client using `SUPABASE_SERVICE_ROLE_KEY` for server-only privileged operations
4. `src/lib/supabase/middleware.ts`: Create middleware helper that refreshes the Supabase auth session on every request using `createServerClient` with cookie get/set/remove
5. `src/app/auth/callback/route.ts`: Create GET route handler — exchange auth code for session, upsert user record in `users` table, redirect to home
6. `src/middleware.ts`: Create root middleware that calls Supabase middleware helper, applies to all routes except static assets
7. `src/lib/hooks/use-auth.ts`: Create `useAuth` hook that provides current user, loading state, sign-in, and sign-out functions

## Implementation Notes

### Browser Client (`src/lib/supabase/client.ts`)
```typescript
'use client';

import { createBrowserClient } from '@supabase/ssr';

import type { Database } from '@/lib/types/database';

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

### Server Client (`src/lib/supabase/server.ts`)
```typescript
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

import type { Database } from '@/lib/types/database';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Called from Server Component — ignore
          }
        },
      },
    }
  );
}
```

### Middleware Helper (`src/lib/supabase/middleware.ts`)
```typescript
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          supabaseResponse = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  await supabase.auth.getUser();
  return supabaseResponse;
}
```

### Auth Callback Route (`src/app/auth/callback/route.ts`)
```typescript
import { NextResponse } from 'next/server';

import { createClient } from '@/lib/supabase/server';

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  const next = searchParams.get('next') ?? '/';

  if (code) {
    const supabase = await createClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      // Upsert user record
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        await supabase.from('users').upsert({
          id: user.id,
          email: user.email!,
          full_name: user.user_metadata.full_name ?? user.email!,
          avatar_url: user.user_metadata.avatar_url ?? null,
        });
      }
      return NextResponse.redirect(`${origin}${next}`);
    }
  }
  return NextResponse.redirect(`${origin}/login?error=auth`);
}
```

### Root Middleware Matcher
```typescript
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

## Acceptance Criteria
- [ ] Browser client creates a singleton Supabase instance with typed `Database` generic
- [ ] Server client correctly reads/writes cookies via Next.js `cookies()` API
- [ ] Admin client uses service role key and is never exposed to the browser
- [ ] Middleware refreshes auth session on every matching request
- [ ] OAuth callback exchanges code for session without errors
- [ ] User record is upserted in `users` table on first sign-in
- [ ] Failed auth redirects to `/login?error=auth`
- [ ] Middleware matcher excludes static assets and images
- [ ] `useAuth` hook returns `{ user, loading, signIn, signOut }`
- [ ] Named exports used for all utility functions
