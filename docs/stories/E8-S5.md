# E8-S5: Build Badge Unlock Toast/Animation

## Description
Create a celebratory Client Component that displays an animated toast notification when a user earns a new badge. The component shows the badge emoji, name, tier, and flair text with a scale-up entrance animation and optional CSS confetti burst effect. It integrates with the shadcn toast system and is triggered when `check_and_award_badges` returns newly awarded badges.

## Dependencies
- Stories: E8-S3 (badge card component, badge constants), E8-S1 (gamification actions)
- Files: `src/lib/constants/badges.ts`, `src/components/ui/toast.tsx` (shadcn toast)

## Tasks
1. `src/components/gamification/badge-unlock.tsx`: Create Client Component that:
   - Accepts a badge object (`badgeType`, `tier`) as props
   - Renders badge emoji (large), badge name, tier label, and flair text
   - Animates entrance with scale 0→1 transition (400ms spring easing)
   - Includes CSS confetti burst effect (keyframe animation with pseudo-elements or particles)
   - Auto-dismisses after 5 seconds
   - Uses shadcn toast for positioning and dismiss behavior
2. `src/lib/hooks/use-badge-unlock.ts`: Create a custom hook or utility that:
   - Listens for new badge awards (from server action responses)
   - Triggers the badge unlock toast when new badges are detected
   - Can be called imperatively: `showBadgeUnlock({ badgeType, tier })`
3. Integration point: Update gamification actions to return new badges that trigger the toast in calling components

## Implementation Notes

### Badge Unlock Component
```tsx
// src/components/gamification/badge-unlock.tsx
'use client';

import { useEffect, useState } from 'react';
import { BADGE_DEFINITIONS, TIER_COLORS, type BadgeType, type BadgeTier } from '@/lib/constants/badges';
import { cn } from '@/lib/utils';

interface BadgeUnlockProps {
  badgeType: BadgeType;
  tier: BadgeTier;
  onDismiss?: () => void;
}

export function BadgeUnlock({ badgeType, tier, onDismiss }: BadgeUnlockProps) {
  const [isVisible, setIsVisible] = useState(false);
  const badge = BADGE_DEFINITIONS[badgeType];
  const tierColor = TIER_COLORS[tier];
  const flair = badge.flair[tier];

  useEffect(() => {
    // Trigger entrance animation
    requestAnimationFrame(() => setIsVisible(true));

    // Auto-dismiss after 5 seconds
    const timeout = setTimeout(() => {
      setIsVisible(false);
      setTimeout(() => onDismiss?.(), 300); // Wait for exit animation
    }, 5000);

    return () => clearTimeout(timeout);
  }, [onDismiss]);

  return (
    <div
      className={cn(
        'fixed inset-0 z-50 flex items-center justify-center pointer-events-none',
        'transition-opacity duration-300',
        isVisible ? 'opacity-100' : 'opacity-0'
      )}
    >
      {/* Confetti burst */}
      <div className={cn('absolute inset-0', isVisible && 'animate-confetti')} />

      {/* Badge card */}
      <div
        className={cn(
          'relative pointer-events-auto rounded-xl border-2 p-6 shadow-2xl',
          'flex flex-col items-center gap-3 text-center',
          'transition-transform duration-400 ease-[cubic-bezier(0.34,1.56,0.64,1)]',
          isVisible ? 'scale-100' : 'scale-0',
          tierColor.border,
          tierColor.bg,
          'bg-card'
        )}
      >
        <p className="text-xs font-medium uppercase tracking-wider text-muted-foreground">
          Lencana Baharu!
        </p>
        <span className="text-5xl animate-bounce-once">{badge.emoji}</span>
        <div>
          <p className="text-lg font-bold">{badge.name}</p>
          <p className={cn('text-sm font-medium uppercase', tierColor.text)}>{tier}</p>
        </div>
        <p className="text-sm italic text-muted-foreground">{flair}</p>
      </div>
    </div>
  );
}
```

### CSS Animations (add to globals.css)
```css
/* Badge unlock animations */
@keyframes confetti-burst {
  0% {
    background-image: radial-gradient(circle, var(--primary) 2px, transparent 2px);
    background-size: 20px 20px;
    opacity: 1;
    transform: scale(0.5);
  }
  100% {
    background-size: 60px 60px;
    opacity: 0;
    transform: scale(2);
  }
}

@keyframes bounce-once {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.animate-confetti {
  animation: confetti-burst 800ms ease-out forwards;
}

.animate-bounce-once {
  animation: bounce-once 600ms ease-out 200ms;
}

.duration-400 {
  transition-duration: 400ms;
}
```

### Custom Hook for Triggering
```ts
// src/lib/hooks/use-badge-unlock.ts
'use client';

import { useState, useCallback } from 'react';
import type { BadgeType, BadgeTier } from '@/lib/constants/badges';

interface NewBadge {
  badgeType: BadgeType;
  tier: BadgeTier;
}

export function useBadgeUnlock() {
  const [badge, setBadge] = useState<NewBadge | null>(null);

  const showBadgeUnlock = useCallback((newBadge: NewBadge) => {
    setBadge(newBadge);
  }, []);

  const dismissBadgeUnlock = useCallback(() => {
    setBadge(null);
  }, []);

  return { badge, showBadgeUnlock, dismissBadgeUnlock };
}
```

### Integration Example
```tsx
// In a Client Component that triggers actions with badge checks
'use client';

import { useBadgeUnlock } from '@/lib/hooks/use-badge-unlock';
import { BadgeUnlock } from '@/components/gamification/badge-unlock';

export function SomeActionComponent() {
  const { badge, showBadgeUnlock, dismissBadgeUnlock } = useBadgeUnlock();

  const handleAction = async () => {
    const result = await someServerAction();
    if (result.newBadges?.length > 0) {
      showBadgeUnlock({
        badgeType: result.newBadges[0].badge_type,
        tier: result.newBadges[0].tier,
      });
    }
  };

  return (
    <>
      {/* ... action UI ... */}
      {badge && (
        <BadgeUnlock
          badgeType={badge.badgeType}
          tier={badge.tier}
          onDismiss={dismissBadgeUnlock}
        />
      )}
    </>
  );
}
```

### Animation Details
- **Scale entrance**: `scale-0` → `scale-100` with spring easing `cubic-bezier(0.34, 1.56, 0.64, 1)` over 400ms
- **Confetti burst**: Radial gradient dots that expand outward and fade (800ms)
- **Emoji bounce**: Single bounce at 200ms delay after card appears
- **Exit**: Opacity fade out over 300ms

### Localization
- "Lencana Baharu!" = "New Badge!"

## Acceptance Criteria
- [ ] Badge unlock component renders with emoji, name, tier, and flair text
- [ ] Entrance animation scales from 0 to 1 with spring easing (400ms)
- [ ] CSS confetti burst effect plays on badge reveal
- [ ] Emoji has a bounce animation after card appears
- [ ] Toast auto-dismisses after 5 seconds
- [ ] `useBadgeUnlock` hook provides `showBadgeUnlock` and `dismissBadgeUnlock` functions
- [ ] Component uses 'use client' directive
- [ ] Tier-specific border and background colors from TIER_COLORS
- [ ] "Lencana Baharu!" header text displays above the badge
- [ ] Animation CSS is added to globals.css
- [ ] Named exports for both `BadgeUnlock` component and `useBadgeUnlock` hook
- [ ] Component is overlay (z-50, fixed positioning) and doesn't disrupt page layout
