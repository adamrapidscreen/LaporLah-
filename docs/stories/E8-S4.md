# E8-S4: Build Profile Page

## Description
Create the user profile page as a Server Component that displays the civic card, earned badges, recent activity feed, and a tab switcher for "My Reports" and "Followed" reports. Also create the public profile view for viewing other users' profiles and a loading skeleton.

## Dependencies
- Stories: E8-S2 (civic card + stats grid), E8-S3 (badge card)
- Files: `src/components/profile/civic-card.tsx`, `src/components/profile/stats-grid.tsx`, `src/components/gamification/badge-card.tsx`

## Tasks
1. `src/app/profile/page.tsx`: Create Server Component (own profile):
   - Fetch authenticated user data from Supabase (users table with points, streak)
   - Fetch user's badges from badges table
   - Fetch stats: reports count, comments count
   - Fetch recent activity from point_events (last 10 entries)
   - Render CivicCard, badges section (up to 3 BadgeCards), activity feed, tab switcher
   - Redirect to login if not authenticated
2. `src/components/profile/activity-feed.tsx`: Create component that displays recent point_events as a timeline:
   - Each entry shows: action icon/emoji, action description, points earned, relative timestamp
   - Action descriptions in Malay (e.g., "Mencipta laporan", "Memberi komen", "Undi pengesahan")
   - Empty state: "Belum ada aktiviti" (No activity yet)
3. `src/app/profile/loading.tsx`: Create loading skeleton matching the profile page layout (civic card skeleton, badge skeletons, activity list skeletons)
4. `src/app/profile/[id]/page.tsx`: Create Server Component (public profile):
   - Fetch user by ID from users table
   - Show CivicCard and badges (same as own profile)
   - Hide activity feed (private to own profile)
   - Show 404 if user not found

## Implementation Notes

### Profile Page (Own)
```tsx
// src/app/profile/page.tsx
import { redirect } from 'next/navigation';
import { createServerClient } from '@/lib/supabase/server';
import { CivicCard } from '@/components/profile/civic-card';
import { BadgeCard } from '@/components/gamification/badge-card';
import { ActivityFeed } from '@/components/profile/activity-feed';
import { BADGE_DEFINITIONS, type BadgeType } from '@/lib/constants/badges';

export default async function ProfilePage() {
  const supabase = await createServerClient();
  const { data: { user: authUser } } = await supabase.auth.getUser();

  if (!authUser) redirect('/login');

  // Fetch user profile
  const { data: user } = await supabase
    .from('users')
    .select('*')
    .eq('id', authUser.id)
    .single();

  if (!user) redirect('/login');

  // Fetch badges
  const { data: badges } = await supabase
    .from('badges')
    .select('badge_type, tier')
    .eq('user_id', authUser.id);

  // Fetch stats
  const { count: reportsCount } = await supabase
    .from('reports')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', authUser.id);

  const { count: commentsCount } = await supabase
    .from('comments')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', authUser.id);

  // Fetch recent activity (last 10 point events)
  const { data: activities } = await supabase
    .from('point_events')
    .select('*')
    .eq('user_id', authUser.id)
    .order('created_at', { ascending: false })
    .limit(10);

  return (
    <div className="space-y-6 p-4 max-w-lg mx-auto">
      <CivicCard
        user={user}
        stats={{
          points: user.total_points,
          reportsCount: reportsCount ?? 0,
          commentsCount: commentsCount ?? 0,
        }}
      />

      {/* Badges Section */}
      <section className="space-y-3">
        <h2 className="text-lg font-semibold">Lencana</h2>
        <div className="grid gap-3">
          {(Object.keys(BADGE_DEFINITIONS) as BadgeType[]).map((badgeType) => {
            const earned = badges?.find(b => b.badge_type === badgeType);
            if (!earned) return null;
            return (
              <BadgeCard
                key={badgeType}
                badgeType={badgeType}
                tier={earned.tier}
                currentCount={0} // Fetched from relevant count query
              />
            );
          })}
        </div>
      </section>

      {/* Activity Feed */}
      <section className="space-y-3">
        <h2 className="text-lg font-semibold">Aktiviti Terkini</h2>
        <ActivityFeed activities={activities ?? []} />
      </section>
    </div>
  );
}
```

### Activity Feed Component
```tsx
// src/components/profile/activity-feed.tsx
import { cn } from '@/lib/utils';

const ACTION_LABELS: Record<string, { emoji: string; label: string }> = {
  create_report: { emoji: 'üìù', label: 'Mencipta laporan' },
  comment: { emoji: 'üí¨', label: 'Memberi komen' },
  new_follower: { emoji: 'üë•', label: 'Pengikut baharu' },
  confirmation_vote: { emoji: '‚úÖ', label: 'Undi pengesahan' },
  report_closed: { emoji: 'üéâ', label: 'Laporan ditutup' },
  resolution_confirmed: { emoji: 'üèÜ', label: 'Penyelesaian disahkan' },
};

interface Activity {
  id: string;
  action: string;
  points: number;
  created_at: string;
}

interface ActivityFeedProps {
  activities: Activity[];
}

export function ActivityFeed({ activities }: ActivityFeedProps) {
  if (activities.length === 0) {
    return (
      <p className="text-sm text-muted-foreground text-center py-8">
        Belum ada aktiviti
      </p>
    );
  }

  return (
    <div className="space-y-3">
      {activities.map((activity) => {
        const config = ACTION_LABELS[activity.action] ?? { emoji: '‚Ä¢', label: activity.action };
        const timeAgo = getRelativeTime(activity.created_at);

        return (
          <div key={activity.id} className="flex items-center gap-3 text-sm">
            <span className="text-lg">{config.emoji}</span>
            <div className="flex-1 min-w-0">
              <p className="truncate">{config.label}</p>
              <p className="text-xs text-muted-foreground">{timeAgo}</p>
            </div>
            <span className="text-xs font-medium text-primary">+{activity.points}</span>
          </div>
        );
      })}
    </div>
  );
}

function getRelativeTime(dateString: string): string {
  const now = new Date();
  const date = new Date(dateString);
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return 'Baru sahaja';
  if (diffMins < 60) return `${diffMins} minit lalu`;
  if (diffHours < 24) return `${diffHours} jam lalu`;
  if (diffDays < 7) return `${diffDays} hari lalu`;
  return date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'short' });
}
```

### Loading Skeleton
```tsx
// src/app/profile/loading.tsx
import { Skeleton } from '@/components/ui/skeleton';

export default function ProfileLoading() {
  return (
    <div className="space-y-6 p-4 max-w-lg mx-auto">
      {/* Civic card skeleton */}
      <div className="border-2 border-muted rounded-lg p-6 flex flex-col items-center gap-4">
        <Skeleton className="h-16 w-16 rounded-full" />
        <Skeleton className="h-6 w-40" />
        <Skeleton className="h-4 w-32" />
        <div className="grid grid-cols-3 gap-4 w-full pt-4 border-t">
          {Array.from({ length: 3 }).map((_, i) => (
            <div key={i} className="flex flex-col items-center gap-1">
              <Skeleton className="h-7 w-12" />
              <Skeleton className="h-3 w-16" />
            </div>
          ))}
        </div>
      </div>

      {/* Badges skeleton */}
      <div className="space-y-3">
        <Skeleton className="h-6 w-24" />
        {Array.from({ length: 3 }).map((_, i) => (
          <Skeleton key={i} className="h-24 w-full rounded-lg" />
        ))}
      </div>

      {/* Activity skeleton */}
      <div className="space-y-3">
        <Skeleton className="h-6 w-32" />
        {Array.from({ length: 5 }).map((_, i) => (
          <div key={i} className="flex items-center gap-3">
            <Skeleton className="h-8 w-8 rounded-full" />
            <div className="flex-1 space-y-1">
              <Skeleton className="h-4 w-40" />
              <Skeleton className="h-3 w-20" />
            </div>
            <Skeleton className="h-4 w-8" />
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Public Profile Page
```tsx
// src/app/profile/[id]/page.tsx
import { notFound } from 'next/navigation';
import { createServerClient } from '@/lib/supabase/server';
import { CivicCard } from '@/components/profile/civic-card';
import { BadgeCard } from '@/components/gamification/badge-card';
import { BADGE_DEFINITIONS, type BadgeType } from '@/lib/constants/badges';

interface PublicProfilePageProps {
  params: Promise<{ id: string }>;
}

export default async function PublicProfilePage({ params }: PublicProfilePageProps) {
  const { id } = await params;
  const supabase = await createServerClient();

  const { data: user } = await supabase
    .from('users')
    .select('*')
    .eq('id', id)
    .single();

  if (!user) notFound();

  const { data: badges } = await supabase
    .from('badges')
    .select('badge_type, tier')
    .eq('user_id', id);

  const { count: reportsCount } = await supabase
    .from('reports')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', id);

  const { count: commentsCount } = await supabase
    .from('comments')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', id);

  return (
    <div className="space-y-6 p-4 max-w-lg mx-auto">
      <CivicCard
        user={user}
        stats={{
          points: user.total_points,
          reportsCount: reportsCount ?? 0,
          commentsCount: commentsCount ?? 0,
        }}
      />

      <section className="space-y-3">
        <h2 className="text-lg font-semibold">Lencana</h2>
        <div className="grid gap-3">
          {(Object.keys(BADGE_DEFINITIONS) as BadgeType[]).map((badgeType) => {
            const earned = badges?.find(b => b.badge_type === badgeType);
            if (!earned) return null;
            return (
              <BadgeCard
                key={badgeType}
                badgeType={badgeType}
                tier={earned.tier}
                currentCount={0}
              />
            );
          })}
        </div>
      </section>
    </div>
  );
}
```

### Localization
- "Lencana" = Badges
- "Aktiviti Terkini" = Recent Activity
- "Belum ada aktiviti" = No activity yet
- Relative time in Malay: "minit lalu", "jam lalu", "hari lalu", "Baru sahaja"
- Action labels all in Malay

## Acceptance Criteria
- [ ] Profile page renders at `/profile` with civic card, badges, and activity feed
- [ ] Unauthenticated users are redirected to `/login`
- [ ] Badges section displays earned badges as BadgeCard components
- [ ] Activity feed shows last 10 point_events with emoji, description, points, and relative time
- [ ] Activity feed empty state shows "Belum ada aktiviti"
- [ ] Loading skeleton displays while data is fetched
- [ ] Public profile page renders at `/profile/[id]` with civic card and badges
- [ ] Public profile hides activity feed (private data)
- [ ] Public profile returns 404 for non-existent user IDs
- [ ] Both pages are Server Components (no 'use client' directive)
- [ ] All components use named exports (per coding standards)
- [ ] Layout uses max-w-lg mx-auto for mobile-first centered layout
