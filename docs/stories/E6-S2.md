# E6-S2: Implement Follow Server Action

## Description
Create the `toggleFollow` server action that checks authentication, toggles the follow state (insert or delete from the `follows` table), awards points to the report creator on new follows, and revalidates the page.

## Dependencies
- Stories: E6-S1 (follow button component), E1-S2 (follows table, award_points DB function)
- Files: `src/components/shared/follow-button.tsx`, database `follows` table

## Tasks
1. `src/lib/actions/follows.ts`: Create the `toggleFollow` server action with authentication check, follow state toggle, point awarding on new follows, and path revalidation.

## Implementation Notes

### toggleFollow Server Action
```tsx
// src/lib/actions/follows.ts
'use server';

import { revalidatePath } from 'next/cache';
import { createServerClient } from '@/lib/supabase/server';

export async function toggleFollow(reportId: string) {
  const supabase = await createServerClient();

  // 1. Check authentication
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { error: 'Not authenticated' };

  // 2. Check if already following
  const { data: existingFollow } = await supabase
    .from('follows')
    .select('id')
    .eq('report_id', reportId)
    .eq('user_id', user.id)
    .maybeSingle();

  if (existingFollow) {
    // 3a. Already following → unfollow (DELETE)
    const { error } = await supabase
      .from('follows')
      .delete()
      .eq('id', existingFollow.id);

    if (error) return { error: 'Failed to unfollow' };

    revalidatePath(`/report/${reportId}`);
    return { followed: false };
  } else {
    // 3b. Not following → follow (INSERT)
    const { error } = await supabase
      .from('follows')
      .insert({
        report_id: reportId,
        user_id: user.id,
      });

    if (error) return { error: 'Failed to follow' };

    // 4. Award points to report creator for gaining a new follower
    const { data: report } = await supabase
      .from('reports')
      .select('user_id')
      .eq('id', reportId)
      .single();

    if (report && report.user_id !== user.id) {
      await supabase.rpc('award_points', {
        p_user_id: report.user_id,
        p_action: 'report_followed',
        p_points: 3,
        p_report_id: reportId,
      });
    }

    revalidatePath(`/report/${reportId}`);
    return { followed: true };
  }
}
```

### Action Flow
1. **Authenticate** — `supabase.auth.getUser()`, return error if not logged in
2. **Check existing** — SELECT from `follows` where `report_id` and `user_id` match
3. **Toggle**:
   - If following → DELETE the follow row (unfollow)
   - If not following → INSERT new follow row
4. **Award points** (only on new follow) — `award_points` to report creator, 3 pts, action `'report_followed'`
   - Skip if the user is following their own report (no self-points)
5. **Revalidate** — `revalidatePath('/report/[id]')`
6. **Return** — `{ followed: boolean }` indicating the new state

### Points System
- New follower on a report awards 3 points to the **report creator** (not the follower)
- Action key: `'report_followed'`
- No points awarded on unfollow
- No points if user follows their own report

### Error Handling
- Return `{ error: string }` on failure — never throw
- Point awarding failure should be logged but not block the response

## Acceptance Criteria
- [ ] `toggleFollow` checks authentication and returns error if not logged in
- [ ] If user is already following, the follow row is deleted (unfollow)
- [ ] If user is not following, a new follow row is inserted
- [ ] On new follow, `award_points` gives 3 points to the report creator
- [ ] No points are awarded if user follows their own report
- [ ] No points are awarded on unfollow
- [ ] Returns `{ followed: true }` on follow and `{ followed: false }` on unfollow
- [ ] `revalidatePath` is called for the report detail page
- [ ] File uses 'use server' directive
- [ ] All errors return `{ error }` objects, never thrown exceptions
