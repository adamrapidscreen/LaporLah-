# E8-S1: Implement Gamification Database Functions and Server Actions

## Description
Create the gamification server action wrappers and constants files that power the points and badges system. This includes wrapper functions around the existing database functions (`award_points`, `check_and_award_badges`, `update_streak`), a points-per-action constant map, and badge definitions with names, emojis, flair text, and tier thresholds. These functions are called internally by other server actions (reports, comments, votes) ‚Äî they are not exposed as standalone API endpoints.

## Dependencies
- Stories: E1-S2 (DB functions: award_points, check_and_award_badges, update_streak exist in migrations)
- Files: `supabase/migrations/003_create_functions.sql`

## Tasks
1. `src/lib/constants/points.ts`: Create points-per-action constant map with all action types and their point values
2. `src/lib/constants/badges.ts`: Create badge definitions with name, emoji, flair text, tier thresholds, and tier colors
3. `src/lib/actions/gamification.ts`: Create server action wrappers around DB RPC functions:
   - `awardPoints(userId, action, reportId?)` ‚Äî looks up points from constant map, calls `award_points` RPC
   - `checkAndAwardBadges(userId)` ‚Äî calls `check_and_award_badges` RPC, returns any newly awarded badges
   - `updateStreak(userId)` ‚Äî calls `update_streak` RPC

## Implementation Notes

### Points Constants
```ts
// src/lib/constants/points.ts

export const POINTS_PER_ACTION = {
  create_report: 10,
  comment: 5,
  new_follower: 3,
  confirmation_vote: 8,
  report_closed: 25,
  resolution_confirmed: 15,
} as const;

export type PointAction = keyof typeof POINTS_PER_ACTION;
```

### Badge Definitions
```ts
// src/lib/constants/badges.ts

export const BADGE_DEFINITIONS = {
  spotter: {
    name: 'Spotter',
    emoji: 'üî¶',
    description: 'Pelapor aktif komuniti',
    flair: {
      bronze: 'Pemerhati Baru',
      silver: 'Pemerhati Berpengalaman',
      gold: 'Pemerhati Utama',
    },
    thresholds: {
      bronze: 1,
      silver: 5,
      gold: 15,
    },
    metric: 'reports created',
  },
  kampung_hero: {
    name: 'Kampung Hero',
    emoji: 'ü§ù',
    description: 'Pembantu komuniti',
    flair: {
      bronze: 'Jiran Prihatin',
      silver: 'Wira Kampung',
      gold: 'Legenda Kampung',
    },
    thresholds: {
      bronze: 5,
      silver: 15,
      gold: 50,
    },
    metric: 'comments on others\' reports',
  },
  closer: {
    name: 'Closer',
    emoji: '‚úÖ',
    description: 'Penyelesai isu',
    flair: {
      bronze: 'Penyelesai Baru',
      silver: 'Penyelesai Handal',
      gold: 'Penyelesai Utama',
    },
    thresholds: {
      bronze: 2,
      silver: 5,
      gold: 15,
    },
    metric: 'confirmed resolutions',
  },
} as const;

export type BadgeType = keyof typeof BADGE_DEFINITIONS;
export type BadgeTier = 'bronze' | 'silver' | 'gold';

export const TIER_COLORS = {
  bronze: { border: 'border-amber-700', bg: 'bg-amber-700/10', text: 'text-amber-700' },
  silver: { border: 'border-slate-400', bg: 'bg-slate-400/10', text: 'text-slate-400' },
  gold: { border: 'border-yellow-500', bg: 'bg-yellow-500/10', text: 'text-yellow-500' },
} as const;
```

### Server Action Wrappers
```ts
// src/lib/actions/gamification.ts
'use server';

import { createServerClient } from '@/lib/supabase/server';
import { POINTS_PER_ACTION, type PointAction } from '@/lib/constants/points';

export async function awardPoints(
  userId: string,
  action: PointAction,
  reportId?: string
) {
  const supabase = await createServerClient();
  const points = POINTS_PER_ACTION[action];

  const { error } = await supabase.rpc('award_points', {
    p_user_id: userId,
    p_action: action,
    p_points: points,
    p_report_id: reportId ?? null,
  });

  if (error) {
    console.error('Failed to award points:', error);
    return { error: 'Failed to award points' };
  }

  return { success: true, points };
}

export async function checkAndAwardBadges(userId: string) {
  const supabase = await createServerClient();

  const { data: newBadges, error } = await supabase.rpc('check_and_award_badges', {
    p_user_id: userId,
  });

  if (error) {
    console.error('Failed to check badges:', error);
    return { error: 'Failed to check badges', badges: [] };
  }

  return { badges: newBadges ?? [] };
}

export async function updateStreak(userId: string) {
  const supabase = await createServerClient();

  const { error } = await supabase.rpc('update_streak', {
    p_user_id: userId,
  });

  if (error) {
    console.error('Failed to update streak:', error);
    return { error: 'Failed to update streak' };
  }

  return { success: true };
}
```

### Integration Pattern
Other server actions call these wrappers internally:
```ts
// Example: in src/lib/actions/reports.ts after creating a report
import { awardPoints, checkAndAwardBadges, updateStreak } from '@/lib/actions/gamification';

// After successful report creation
await awardPoints(userId, 'create_report', reportId);
await checkAndAwardBadges(userId);
await updateStreak(userId);
```

## Acceptance Criteria
- [ ] `POINTS_PER_ACTION` map is exported from `src/lib/constants/points.ts` with all 6 action types
- [ ] `PointAction` type is exported for type-safe action lookups
- [ ] `BADGE_DEFINITIONS` is exported from `src/lib/constants/badges.ts` with all 3 badge types
- [ ] Each badge has name, emoji, flair text per tier, thresholds per tier, and metric description
- [ ] `TIER_COLORS` map is exported with border/bg/text classes for bronze, silver, gold
- [ ] `awardPoints` wrapper correctly looks up points from constant map and calls RPC
- [ ] `checkAndAwardBadges` wrapper calls RPC and returns newly awarded badges array
- [ ] `updateStreak` wrapper calls RPC and returns success/error
- [ ] All server actions return `{ error }` on failure (no thrown exceptions)
- [ ] All files use named exports (per coding standards)
- [ ] `src/lib/actions/gamification.ts` uses 'use server' directive
